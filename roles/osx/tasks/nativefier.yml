
- block: 

  - name: Check if already installed
    stat: 
      path: "{{apps_dir}}/{{item.name}}.app"
    register: st

  - name: Install {{item.name}} x86 app
    block:   

      - name: Build {{item.name}}
        shell: "nativefier -n '{{item.name}}' --internal-urls '.*' '{{item.url}}'"

      - name: Move built {{item.name}} app to {{apps_dir}}
        shell: "mv {{item.name | regex_replace('\\s', '\\ ')}}-darwin-x64/{{item.name | regex_replace('\\s', '\\ ')}}.app {{apps_dir}}/"
  
      - name: Cleanup remaining artifacts
        file: 
          path: "{{item.name}}-darwin-x64"
          state: absent

    when: 
     - not st.stat.exists
     - ansible_architecture == "x86_64"

  - name: Install {{item.name}} arm64 app
    block:   

      - name: Build {{item.name}}
        shell: "nativefier -n '{{item.name}}' --internal-urls '.*' '{{item.url}}'"
  
      - name: Move built {{item.name}} app to {{apps_dir}}
        shell: "mv {{item.name | regex_replace('\\s', '\\ ')}}-darwin-arm64/{{item.name | regex_replace('\\s', '\\ ')}}.app {{apps_dir}}/"
        when: ansible_architecture == "arm64"
      
      - name: Cleanup remaining artifacts
        file: 
          path: "{{item.name}}-darwin-arm64"
          state: absent

    when: 
     - not st.stat.exists
     - ansible_architecture == "arm64"
  
  tags: 
    - apps
    - nativefier